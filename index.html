<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban N2 (Hermes)</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --font-family: 'Poppins', sans-serif;
            --column-bg: rgba(22, 22, 38, 0.4);
            --card-bg: #2a2d4d;
            --text-primary: #f0f0f0;
            --text-secondary: #b0b8d1;
            --accent-color: #4a90e2;
            --accent-hover: #5aa1f2;
            --success-color: #5aac44;
            --error-color: #e53935;
            --border-color: rgba(255, 255, 255, 0.15);
            --border-radius: 12px;
        }
        body::before {
            content: ''; position: fixed; top: 0; left: 0; height: 100vh; width: 100vw; z-index: -1;
            background-image: url('https://i.imgur.com/55lGGhS.jpg'); background-size: cover; background-position: center; filter: blur(4px);
        }
        body {
            font-family: var(--font-family); background-color: rgba(13, 17, 46, 0.7);
            color: var(--text-primary); margin: 0;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; padding: 25px; box-sizing: border-box;
        }

        .hidden { display: none !important; }

        /* --- Estilos da Tela de Login --- */
        #auth-container {
            display: flex; justify-content: center; align-items: center; width: 100%; flex-grow: 1;
        }
        .login-container {
            background: rgba(22, 22, 38, 0.6); border: 1px solid var(--border-color);
            backdrop-filter: blur(15px); padding: 40px; border-radius: 12px;
            width: 90%; max-width: 400px; box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }
        .login-container h1 { font-weight: 700; text-align: center; margin-top: 0; }
        .tabs { display: flex; border-bottom: 1px solid var(--text-secondary); margin-bottom: 20px; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; font-weight: 500; border-bottom: 3px solid transparent; }
        .tab.active { border-bottom-color: var(--accent-color); }
        .login-container form { display: none; flex-direction: column; gap: 15px; }
        .login-container form.active { display: flex; }
        .input-group { display: flex; flex-direction: column; }
        .input-group label { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px; }
        .login-container input {
            background: rgba(0,0,0,0.2); border: 1px solid var(--text-secondary);
            border-radius: 8px; padding: 12px; font-size: 1rem; color: var(--text-primary);
        }
        .login-container button {
            background-color: var(--accent-color); color: white; border: none; padding: 12px;
            border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 10px;
            font-size: 1rem; transition: background-color 0.3s ease;
        }
        .login-container button:hover { background-color: var(--accent-hover); }
        .message { margin-top: 15px; text-align: center; padding: 10px; border-radius: 5px; font-weight: 500; }
        .message.error { background-color: var(--error-color); }
        .message.success { background-color: var(--success-color); }

        /* --- Estilos do App Kanban --- */
        #kanban-app { width: 100%; }
        .header {
            width: 100%; max-width: 1800px; display: flex;
            justify-content: space-between; align-items: center; margin: 0 auto 20px auto;
        }
        .header h1 { margin: 0; font-weight: 700; font-size: 2.5rem; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        #logout-button {
            background-color: #c44a3a;
            color: white; border: none; padding: 10px 20px;
            border-radius: 8px; font-weight: 600; cursor: pointer;
            font-size: 0.9rem; transition: background-color 0.3s ease;
        }
        #logout-button:hover { background-color: var(--delete-color); }

        .kanban-board { display: flex; gap: 25px; width: 100%; max-width: 1800px; align-items: flex-start; overflow-x: auto; padding: 20px 10px; margin: 0 auto; }
        .kanban-column { background: var(--column-bg); border: 1px solid var(--border-color); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-radius: var(--border-radius); padding: 15px; min-width: 320px; width: 320px; display: flex; flex-direction: column; gap: 20px;
        }
        .kanban-column h2 { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); margin: 0; padding: 0 5px; }
        .cards-container { display: flex; flex-direction: column; gap: 15px; min-height: 100px; }
        .card { background-color: var(--card-bg); border-radius: 8px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); cursor: grab; position: relative; border: 1px solid transparent; transition: all 0.3s ease; display: flex; flex-direction: column; gap: 10px; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 8px 25px rgba(0,0,0,0.2); border-color: var(--accent-color); }
        .card-labels { display: flex; flex-wrap: wrap; gap: 6px; }
        .card-label { padding: 3px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
        .card-text { font-size: 0.95rem; font-weight: 500; line-height: 1.4; cursor: pointer; }
        .card-description-snippet { font-size: 0.8rem; color: var(--text-secondary); line-height: 1.5; max-height: 50px; overflow: hidden; text-overflow: ellipsis; }
        .card-footer { display: flex; justify-content: flex-end; align-items: center; margin-top: 10px; }
        .card-owner { width: 28px; height: 28px; border-radius: 50%; background-color: #777; color: white; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .delete-card { position: absolute; top: 10px; right: 10px; cursor: pointer; color: var(--text-secondary); font-size: 1.2rem; opacity: 0; transition: opacity 0.3s ease, color 0.3s ease; }
        .card:hover .delete-card { opacity: 1; }
        .delete-card:hover { color: var(--delete-color); }

        /* --- CORREÇÃO: Estilos para o formulário "Nova Atividade" --- */
        .add-card-form { display: flex; margin-top: auto; /* Empurra para o final da coluna */ }
        .add-card-input {
            width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border-color);
            border-radius: 8px 0 0 8px; padding: 10px 15px; font-size: 0.9rem;
            color: var(--text-primary); outline: none; transition: background-color 0.3s ease;
        }
        .add-card-input::placeholder { color: var(--text-secondary); }
        .add-card-input:focus { background: rgba(0,0,0,0.4); }
        .add-card-btn {
            background-color: var(--accent-color); color: white; border: none;
            border-radius: 0 8px 8px 0; padding: 0 18px; cursor: pointer;
            font-size: 1.5rem; transition: background-color 0.3s ease;
        }
        .add-card-btn:hover { background-color: var(--accent-hover); }

        /* --- Estilos do Modal --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1000; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.visible { display: flex; opacity: 1; }
        .modal-content { background: var(--column-bg); border: 1px solid var(--border-color); backdrop-filter: blur(15px); padding: 30px; border-radius: var(--border-radius); width: 90%; max-width: 650px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); position: relative; transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 2rem; cursor: pointer; }
        .modal-field { margin-top: 20px; }
        .modal-field strong, .modal-field h4 { font-weight: 600; color: var(--text-secondary); margin-bottom: 10px; }
        .modal-content input[type="text"], .modal-content textarea { width: 100%; background: rgba(0,0,0,0.2); border: 1px solid var(--border-color); border-radius: 8px; padding: 12px; font-size: 0.9rem; color: var(--text-primary); box-sizing: border-box; margin-top: 5px; }
        .modal-content textarea { min-height: 120px; resize: vertical; }
        .modal-labels { display: flex; flex-direction: column; gap: 8px; }
        .modal-label-option { display: flex; align-items: center; cursor: pointer; padding: 5px; border-radius: 5px; }
        .modal-label-option:hover { background: rgba(255,255,255,0.1); }
        .modal-label-option input { margin-right: 10px; }
        .modal-label-option .card-label { margin-left: auto; }
        .modal-save-btn { background-color: var(--success-color); color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: 500; cursor: pointer; margin-top: 30px; font-size: 1rem; }
    </style>
</head>
<body>

    <div id="auth-container">
        <div class="login-container">
            <h1>Kanban N2 (Hermes)</h1>
            <div class="tabs">
                <div class="tab active" data-form="signin">Entrar</div>
                <div class="tab" data-form="signup">Criar Conta</div>
            </div>
            <form id="form-signin" class="active">
                <div class="input-group"><label for="signin-email">Email</label><input type="email" id="signin-email" required></div>
                <div class="input-group"><label for="signin-password">Senha</label><input type="password" id="signin-password" required></div>
                <button type="submit">Entrar</button>
            </form>
            <form id="form-signup">
                <div class="input-group"><label for="signup-name">Nome Completo</label><input type="text" id="signup-name" required></div>
                <div class="input-group"><label for="signup-email">Email</label><input type="email" id="signup-email" required></div>
                <div class="input-group"><label for="signup-password">Crie uma Senha (mín. 6 caracteres)</label><input type="password" id="signup-password" required minlength="6"></div>
                <button type="submit">Criar Conta</button>
            </form>
            <div id="message-area" class="message" style="display: none;"></div>
        </div>
    </div>

    <div id="kanban-app" class="hidden">
        <div class="header">
            <h1 id="kanban-title">Kanban N2 (Hermes)</h1>
            <button id="logout-button">Sair</button>
        </div>
        <div class="kanban-board"></div>
        <div class="modal-overlay" id="card-modal">
            <div class="modal-content">
                <span class="modal-close" id="modal-close-btn">&times;</span>
                <h3 id="modal-title"></h3>
                <div class="modal-field"><p><strong>Responsável (Owner)</strong></p><input type="text" id="modal-owner" placeholder="Nome completo do responsável"></div>
                <div class="modal-field"><p><strong>Descrição</strong></p><textarea id="modal-description" placeholder="Adicione uma descrição mais detalhada..."></textarea></div>
                <div class="modal-field"><h4>Etiquetas (Tags)</h4><div class="modal-labels" id="modal-labels"></div></div>
                <button class="modal-save-btn" id="modal-save-btn">Salvar Alterações</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://jlyigpmltxyicpyhaytl.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_mIaLTnBFCZNu8OZ5J-N7Sg_Pj6W6zW2';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const authContainer = document.getElementById('auth-container');
        const kanbanApp = document.getElementById('kanban-app');
        const logoutButton = document.getElementById('logout-button');
        const formSignin = document.getElementById('form-signin');
        const formSignup = document.getElementById('form-signup');
        const tabs = document.querySelectorAll('.tab');
        const messageArea = document.getElementById('message-area');
        
        let currentUser = null;
        let isKanbanInitialized = false;

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                formSignin.classList.toggle('active', tab.dataset.form === 'signin');
                formSignup.classList.toggle('active', tab.dataset.form === 'signup');
            });
        });

        function showMessage(message, type = 'error') {
            messageArea.textContent = message;
            messageArea.className = `message ${type}`;
            messageArea.style.display = 'block';
        }

        formSignup.addEventListener('submit', async (e) => {
            e.preventDefault();
            showMessage('Criando conta...', 'success');
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const { data, error } = await sb.auth.signUp({
                email, password, options: { data: { full_name: name } }
            });
            if (error) {
                showMessage(`Erro: ${error.message}`);
            } else {
                showMessage('Conta criada! Faça o login para continuar.', 'success');
                tabs[0].click(); 
                formSignin.querySelector('#signin-email').value = email;
            }
        });

        formSignin.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signin-email').value;
            const password = document.getElementById('signin-password').value;
            const { data, error } = await sb.auth.signInWithPassword({ email, password });
            if (error) {
                showMessage(`Erro: ${error.message}`);
            } else if (data.session) {
                checkAuthState(); 
            }
        });
        
        logoutButton.addEventListener('click', async () => {
            await sb.auth.signOut();
            isKanbanInitialized = false; 
            checkAuthState(); 
        });

        async function checkAuthState() {
            const { data: { session } } = await sb.auth.getSession();
            currentUser = session?.user || null;
            if (currentUser) {
                authContainer.classList.add('hidden');
                kanbanApp.classList.remove('hidden');
                if (!isKanbanInitialized) {
                    initializeKanban(); 
                    isKanbanInitialized = true;
                }
            } else {
                authContainer.classList.remove('hidden');
                kanbanApp.classList.add('hidden');
            }
        }
        
        function initializeKanban() {
            const kanbanBoard = kanbanApp.querySelector('.kanban-board');
            if(kanbanBoard.children.length === 0) {
                const columnNames = { "todo-cards": "Atividade", "inprogress-cards": "Em andamento", "pending-cards": "Pendente", "done-cards": "Concluído" };
                for (const [id, title] of Object.entries(columnNames)) {
                    kanbanBoard.innerHTML += `
                        <div class="kanban-column">
                            <h2>${title}</h2>
                            <div class="cards-container" data-column-id="${id}"></div>
                            <form class="add-card-form"><input type="text" class="add-card-input" placeholder="Nova atividade..."><button type="submit" class="add-card-btn">+</button></form>
                        </div>`;
                }
            }
            
            let draggedCard = null;
            let currentEditingCard = null;
            const LABEL_DEFINITIONS = {
                pending: { text: 'Pendente', color: '#E0E0E0', textColor: '#000' },
                low:     { text: 'Prioridade Baixa', color: '#43a047', textColor: '#fff' },
                medium:  { text: 'Prioridade Média', color: '#ffb300', textColor: '#000' },
                high:    { text: 'Prioridade Alta', color: '#f4511e', textColor: '#fff' },
                urgent:  { text: 'Isto é pra ontem!', color: '#8e24aa', textColor: '#fff' },
            };
            const AVATAR_COLORS = ['#e53935','#d81b60','#8e24aa','#5e35b1','#3949ab','#1e88e5','#039be5','#00acc1','#00897b','#43a047','#7cb342','#c0ca33','#fdd835','#ffb300','#fb8c00','#f4511e','#6d4c41','#757575','#546e7a'];
            
            document.querySelectorAll('.add-card-form').forEach(f => f.addEventListener('submit', onAddCardSubmit));
            document.querySelectorAll('.cards-container').forEach(c => c.addEventListener('dragover', onDragOver));

            async function loadCardsFromDB() {
                const { data: cards, error } = await sb.from('cards').select('*').order('created_at', { ascending: true });
                if (error) { console.error('ERRO AO CARREGAR CARDS:', error); return; }
                document.querySelectorAll('.cards-container').forEach(c => c.innerHTML = '');
                cards.forEach(cardData => {
                    const container = document.querySelector(`.cards-container[data-column-id="${cardData.column_id}"]`);
                    if (container) container.appendChild(createCardElement(cardData));
                });
            }

            async function onAddCardSubmit(e) {
                e.preventDefault();
                const input = e.target.querySelector('.add-card-input');
                const text = input.value.trim();
                const container = e.target.previousElementSibling;
                const columnId = container.dataset.columnId;
                if (text && columnId) {
                    const { data, error } = await sb.from('cards').insert([{ text, column_id: columnId, owner: currentUser.user_metadata.full_name }]).select();
                    if (error) { console.error('ERRO AO ADICIONAR CARD:', error); return; }
                    const newCardData = data[0];
                    if (newCardData) container.appendChild(createCardElement(newCardData));
                    input.value = '';
                }
            }

            function createCardElement(cardData) {
                const card = document.createElement('div');
                card.className = 'card';
                card.draggable = true;
                card.dataset.id = cardData.id;
                card.dataset.description = cardData.description || '';
                card.dataset.labels = JSON.stringify(cardData.labels || []);
                card.dataset.columnId = cardData.column_id;
                card.dataset.owner = cardData.owner || '';
                card.innerHTML = `<div class="card-labels"></div><div class="card-text"></div><p class="card-description-snippet"></p><div class="card-footer"></div><span class="delete-card">&times;</span>`;
                card.querySelector('.card-text').textContent = cardData.text;
                updateCardUI(card);
                addEventListenersToCard(card);
                return card;
            }

            function updateCardUI(card) {
                updateCardLabels(card);
                updateCardDescriptionSnippet(card);
                updateCardOwnerDisplay(card);
            }

            function updateCardLabels(card) {
                const labelsContainer = card.querySelector('.card-labels');
                const labelKeys = JSON.parse(card.dataset.labels || '[]');
                labelsContainer.innerHTML = '';
                labelKeys.forEach(key => {
                    const labelInfo = LABEL_DEFINITIONS[key];
                    if (labelInfo) {
                        const labelDiv = document.createElement('span');
                        labelDiv.className = 'card-label';
                        labelDiv.textContent = labelInfo.text;
                        labelDiv.style.backgroundColor = labelInfo.color;
                        labelDiv.style.color = labelInfo.textColor;
                        labelsContainer.appendChild(labelDiv);
                    }
                });
            }

            function updateCardDescriptionSnippet(card) {
                const snippetP = card.querySelector('.card-description-snippet');
                const fullDesc = card.dataset.description;
                if (fullDesc && snippetP) snippetP.textContent = fullDesc.length > 100 ? fullDesc.substring(0, 100) + '...' : fullDesc;
                else if(snippetP) snippetP.textContent = '';
            }

            function updateCardOwnerDisplay(card) {
                const cardFooter = card.querySelector('.card-footer');
                cardFooter.innerHTML = ''; 
                const ownerName = card.dataset.owner;
                if (ownerName) {
                    const ownerAvatar = document.createElement('div');
                    ownerAvatar.className = 'card-owner';
                    ownerAvatar.textContent = getInitials(ownerName);
                    ownerAvatar.style.backgroundColor = getColorForName(ownerName);
                    cardFooter.appendChild(ownerAvatar);
                }
            }

            function getInitials(name) {
                if (!name) return '';
                const parts = name.trim().split(' ').filter(Boolean);
                if (parts.length === 0) return '';
                if (parts.length === 1) return parts[0].substring(0, 2);
                return parts[0][0] + parts[parts.length - 1][0];
            }

            function getColorForName(name) {
                if (!name) return '#777';
                let hash = 0;
                for (let i = 0; i < name.length; i++) { hash = name.charCodeAt(i) + ((hash << 5) - hash); }
                const index = Math.abs(hash % AVATAR_COLORS.length);
                return AVATAR_COLORS[index];
            }
            
            function addEventListenersToCard(card) {
                card.addEventListener('dragstart', (e) => { draggedCard = e.target; setTimeout(() => e.target.classList.add('dragging'), 0); });
                card.addEventListener('dragend', async (e) => {
                    if(!draggedCard) return;
                    draggedCard.classList.remove('dragging');
                    const newColumnId = draggedCard.parentElement.dataset.columnId;
                    const cardId = draggedCard.dataset.id;
                    if (draggedCard.dataset.columnId !== newColumnId) {
                        draggedCard.dataset.columnId = newColumnId;
                        await sb.from('cards').update({ column_id: newColumnId }).eq('id', cardId);
                    }
                    draggedCard = null;
                });
                card.querySelector('.card-text').addEventListener('click', () => openModal(card));
                card.querySelector('.delete-card').addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if (confirm('Tem certeza que deseja deletar este card?')) {
                        await sb.from('cards').delete().eq('id', card.dataset.id);
                        card.remove();
                    }
                });
            }

            function onDragOver(e) {
                e.preventDefault();
                const container = e.currentTarget;
                const afterElement = getDragAfterElement(container, e.clientY);
                if (draggedCard) {
                    if (afterElement == null) container.appendChild(draggedCard);
                    else container.insertBefore(draggedCard, afterElement);
                }
            }

            function getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.card:not(.dragging)')];
                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) return { offset, element: child };
                    else return closest;
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }

            const modal = document.getElementById('card-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalOwner = document.getElementById('modal-owner');
            const modalDescription = document.getElementById('modal-description');
            const modalLabels = document.getElementById('modal-labels');
            const modalCloseBtn = document.getElementById('modal-close-btn');
            const modalSaveBtn = document.getElementById('modal-save-btn');

            function openModal(card) {
                currentEditingCard = card;
                modalTitle.textContent = card.querySelector('.card-text').textContent;
                modalOwner.value = card.dataset.owner || currentUser.user_metadata.full_name || '';
                modalDescription.value = card.dataset.description || '';
                modalLabels.innerHTML = '';
                const currentLabelKeys = JSON.parse(card.dataset.labels || '[]');
                Object.keys(LABEL_DEFINITIONS).forEach(key => {
                    const labelInfo = LABEL_DEFINITIONS[key];
                    const labelOption = document.createElement('label');
                    labelOption.className = 'modal-label-option';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.value = key;
                    if (currentLabelKeys.includes(key)) checkbox.checked = true;
                    const labelText = document.createElement('span');
                    labelText.textContent = ` ${labelInfo.text}`;
                    const labelPreview = document.createElement('span');
                    labelPreview.className = 'card-label';
                    labelPreview.textContent = labelInfo.text;
                    labelPreview.style.backgroundColor = labelInfo.color;
                    labelPreview.style.color = labelInfo.textColor;
                    labelOption.append(checkbox, labelText, labelPreview);
                    modalLabels.appendChild(labelOption);
                });
                modal.classList.add('visible');
            }

            function closeModal() { modal.classList.remove('visible'); }
            
            modalSaveBtn.addEventListener('click', async () => {
                if (!currentEditingCard) return;
                const cardId = currentEditingCard.dataset.id;
                const updates = {
                    owner: modalOwner.value.trim(),
                    description: modalDescription.value.trim(),
                    labels: Array.from(modalLabels.querySelectorAll('input:checked')).map(el => el.value)
                };
                await sb.from('cards').update(updates).eq('id', cardId);
                currentEditingCard.dataset.owner = updates.owner;
                currentEditingCard.dataset.description = updates.description;
                currentEditingCard.dataset.labels = JSON.stringify(updates.labels);
                updateCardUI(currentEditingCard);
                closeModal();
            });

            modalCloseBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
            
            loadCardsFromDB();
        }

        checkAuthState();
    </script>
</body>
</html>
